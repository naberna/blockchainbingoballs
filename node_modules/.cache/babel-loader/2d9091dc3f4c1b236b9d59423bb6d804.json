{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ReconnectingSocket = void 0;\n\nconst xstream_1 = require(\"xstream\");\n\nconst queueingstreamingsocket_1 = require(\"./queueingstreamingsocket\");\n/**\n * A wrapper around QueueingStreamingSocket that reconnects automatically.\n */\n\n\nclass ReconnectingSocket {\n  constructor(url) {\n    let timeout = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 10000;\n    let reconnectedHandler = arguments.length > 2 ? arguments[2] : undefined;\n    this.unconnected = true;\n    this.disconnected = false;\n    this.timeoutIndex = 0;\n    this.reconnectTimeout = null;\n    const eventProducer = {\n      start: listener => this.eventProducerListener = listener,\n      stop: () => this.eventProducerListener = undefined\n    };\n    this.events = xstream_1.Stream.create(eventProducer);\n    this.socket = new queueingstreamingsocket_1.QueueingStreamingSocket(url, timeout, reconnectedHandler);\n    this.socket.events.subscribe({\n      next: event => {\n        if (this.eventProducerListener) {\n          this.eventProducerListener.next(event);\n        }\n      },\n      error: error => {\n        if (this.eventProducerListener) {\n          this.eventProducerListener.error(error);\n        }\n      }\n    });\n    this.connectionStatus = this.socket.connectionStatus;\n    this.connectionStatus.updates.subscribe({\n      next: status => {\n        if (status === queueingstreamingsocket_1.ConnectionStatus.Connected) {\n          this.timeoutIndex = 0;\n        }\n\n        if (status === queueingstreamingsocket_1.ConnectionStatus.Disconnected) {\n          if (this.reconnectTimeout) {\n            clearTimeout(this.reconnectTimeout);\n            this.reconnectTimeout = null;\n          }\n\n          this.reconnectTimeout = setTimeout(() => this.socket.reconnect(), ReconnectingSocket.calculateTimeout(this.timeoutIndex++));\n        }\n      }\n    });\n  }\n  /** Starts with a 0.1 second timeout, then doubles every attempt with a maximum timeout of 5 seconds. */\n\n\n  static calculateTimeout(index) {\n    return Math.min(2 ** index * 100, 5000);\n  }\n\n  connect() {\n    if (!this.unconnected) {\n      throw new Error(\"Cannot connect: socket has already connected\");\n    }\n\n    this.socket.connect();\n    this.unconnected = false;\n  }\n\n  disconnect() {\n    if (this.unconnected) {\n      throw new Error(\"Cannot disconnect: socket has not yet connected\");\n    }\n\n    this.socket.disconnect();\n\n    if (this.eventProducerListener) {\n      this.eventProducerListener.complete();\n    }\n\n    this.disconnected = true;\n  }\n\n  queueRequest(request) {\n    if (this.disconnected) {\n      throw new Error(\"Cannot queue request: socket has disconnected\");\n    }\n\n    this.socket.queueRequest(request);\n  }\n\n}\n\nexports.ReconnectingSocket = ReconnectingSocket;","map":{"version":3,"mappings":";;;;;;;AACA;;AAEA;AAGA;;;;;AAGA,MAAaA,kBAAb,CAA+B;EAgB7BC,YAAmBC,GAAnB,EAAiF;IAAA,IAAjDC,OAAiD,uEAAvC,KAAuC;IAAA,IAA/BC,kBAA+B;IALzE,mBAAc,IAAd;IACA,oBAAe,KAAf;IACA,oBAAe,CAAf;IACA,wBAA0C,IAA1C;IAGN,MAAMC,aAAa,GAAkB;MACnCC,KAAK,EAAGC,QAAD,IAAe,KAAKC,qBAAL,GAA6BD,QADhB;MAEnCE,IAAI,EAAE,MAAO,KAAKD,qBAAL,GAA6BE;IAFP,CAArC;IAIA,KAAKC,MAAL,GAAcC,iBAAOC,MAAP,CAAcR,aAAd,CAAd;IAEA,KAAKS,MAAL,GAAc,IAAIC,iDAAJ,CAA4Bb,GAA5B,EAAiCC,OAAjC,EAA0CC,kBAA1C,CAAd;IACA,KAAKU,MAAL,CAAYH,MAAZ,CAAmBK,SAAnB,CAA6B;MAC3BC,IAAI,EAAGC,KAAD,IAAU;QACd,IAAI,KAAKV,qBAAT,EAAgC;UAC9B,KAAKA,qBAAL,CAA2BS,IAA3B,CAAgCC,KAAhC;QACD;MACF,CAL0B;MAM3BC,KAAK,EAAGA,KAAD,IAAU;QACf,IAAI,KAAKX,qBAAT,EAAgC;UAC9B,KAAKA,qBAAL,CAA2BW,KAA3B,CAAiCA,KAAjC;QACD;MACF;IAV0B,CAA7B;IAaA,KAAKC,gBAAL,GAAwB,KAAKN,MAAL,CAAYM,gBAApC;IACA,KAAKA,gBAAL,CAAsBC,OAAtB,CAA8BL,SAA9B,CAAwC;MACtCC,IAAI,EAAGK,MAAD,IAAW;QACf,IAAIA,MAAM,KAAKP,2CAAiBQ,SAAhC,EAA2C;UACzC,KAAKC,YAAL,GAAoB,CAApB;QACD;;QACD,IAAIF,MAAM,KAAKP,2CAAiBU,YAAhC,EAA8C;UAC5C,IAAI,KAAKC,gBAAT,EAA2B;YACzBC,YAAY,CAAC,KAAKD,gBAAN,CAAZ;YACA,KAAKA,gBAAL,GAAwB,IAAxB;UACD;;UACD,KAAKA,gBAAL,GAAwBE,UAAU,CAChC,MAAM,KAAKd,MAAL,CAAYe,SAAZ,EAD0B,EAEhC7B,kBAAkB,CAAC8B,gBAAnB,CAAoC,KAAKN,YAAL,EAApC,CAFgC,CAAlC;QAID;MACF;IAfqC,CAAxC;EAiBD;EAtDD;;;EAC+B,OAAhBM,gBAAgB,CAACC,KAAD,EAAc;IAC3C,OAAOC,IAAI,CAACC,GAAL,CAAS,KAAKF,KAAL,GAAa,GAAtB,EAA2B,IAA3B,CAAP;EACD;;EAqDMG,OAAO;IACZ,IAAI,CAAC,KAAKC,WAAV,EAAuB;MACrB,MAAM,IAAIC,KAAJ,CAAU,8CAAV,CAAN;IACD;;IACD,KAAKtB,MAAL,CAAYoB,OAAZ;IACA,KAAKC,WAAL,GAAmB,KAAnB;EACD;;EAEME,UAAU;IACf,IAAI,KAAKF,WAAT,EAAsB;MACpB,MAAM,IAAIC,KAAJ,CAAU,iDAAV,CAAN;IACD;;IACD,KAAKtB,MAAL,CAAYuB,UAAZ;;IACA,IAAI,KAAK7B,qBAAT,EAAgC;MAC9B,KAAKA,qBAAL,CAA2B8B,QAA3B;IACD;;IACD,KAAKC,YAAL,GAAoB,IAApB;EACD;;EAEMC,YAAY,CAACC,OAAD,EAAgB;IACjC,IAAI,KAAKF,YAAT,EAAuB;MACrB,MAAM,IAAIH,KAAJ,CAAU,+CAAV,CAAN;IACD;;IACD,KAAKtB,MAAL,CAAY0B,YAAZ,CAAyBC,OAAzB;EACD;;AAjF4B;;AAA/BC","names":["ReconnectingSocket","constructor","url","timeout","reconnectedHandler","eventProducer","start","listener","eventProducerListener","stop","undefined","events","xstream_1","create","socket","queueingstreamingsocket_1","subscribe","next","event","error","connectionStatus","updates","status","Connected","timeoutIndex","Disconnected","reconnectTimeout","clearTimeout","setTimeout","reconnect","calculateTimeout","index","Math","min","connect","unconnected","Error","disconnect","complete","disconnected","queueRequest","request","exports"],"sourceRoot":"","sources":["../src/reconnectingsocket.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}