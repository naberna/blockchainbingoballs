{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.stringToPath = exports.pathToString = exports.Slip10 = exports.Slip10RawIndex = exports.slip10CurveFromString = exports.Slip10Curve = void 0;\n\nconst encoding_1 = require(\"@cosmjs/encoding\");\n\nconst math_1 = require(\"@cosmjs/math\");\n\nconst bn_js_1 = __importDefault(require(\"bn.js\"));\n\nconst elliptic_1 = __importDefault(require(\"elliptic\"));\n\nconst hmac_1 = require(\"./hmac\");\n\nconst sha_1 = require(\"./sha\");\n/**\n * Raw values must match the curve string in SLIP-0010 master key generation\n *\n * @see https://github.com/satoshilabs/slips/blob/master/slip-0010.md#master-key-generation\n */\n\n\nvar Slip10Curve;\n\n(function (Slip10Curve) {\n  Slip10Curve[\"Secp256k1\"] = \"Bitcoin seed\";\n  Slip10Curve[\"Ed25519\"] = \"ed25519 seed\";\n})(Slip10Curve = exports.Slip10Curve || (exports.Slip10Curve = {}));\n/**\n * Reverse mapping of Slip10Curve\n */\n\n\nfunction slip10CurveFromString(curveString) {\n  switch (curveString) {\n    case Slip10Curve.Ed25519:\n      return Slip10Curve.Ed25519;\n\n    case Slip10Curve.Secp256k1:\n      return Slip10Curve.Secp256k1;\n\n    default:\n      throw new Error(`Unknown curve string: '${curveString}'`);\n  }\n}\n\nexports.slip10CurveFromString = slip10CurveFromString;\n\nclass Slip10RawIndex extends math_1.Uint32 {\n  static hardened(hardenedIndex) {\n    return new Slip10RawIndex(hardenedIndex + 2 ** 31);\n  }\n\n  static normal(normalIndex) {\n    return new Slip10RawIndex(normalIndex);\n  }\n\n  isHardened() {\n    return this.data >= 2 ** 31;\n  }\n\n}\n\nexports.Slip10RawIndex = Slip10RawIndex;\nconst secp256k1 = new elliptic_1.default.ec(\"secp256k1\"); // Universal private key derivation accoring to\n// https://github.com/satoshilabs/slips/blob/master/slip-0010.md\n\nclass Slip10 {\n  static derivePath(curve, seed, path) {\n    let result = this.master(curve, seed);\n\n    for (const rawIndex of path) {\n      result = this.child(curve, result.privkey, result.chainCode, rawIndex);\n    }\n\n    return result;\n  }\n\n  static master(curve, seed) {\n    const i = new hmac_1.Hmac(sha_1.Sha512, (0, encoding_1.toAscii)(curve)).update(seed).digest();\n    const il = i.slice(0, 32);\n    const ir = i.slice(32, 64);\n\n    if (curve !== Slip10Curve.Ed25519 && (this.isZero(il) || this.isGteN(curve, il))) {\n      return this.master(curve, i);\n    }\n\n    return {\n      chainCode: ir,\n      privkey: il\n    };\n  }\n\n  static child(curve, parentPrivkey, parentChainCode, rawIndex) {\n    let i;\n\n    if (rawIndex.isHardened()) {\n      const payload = new Uint8Array([0x00, ...parentPrivkey, ...rawIndex.toBytesBigEndian()]);\n      i = new hmac_1.Hmac(sha_1.Sha512, parentChainCode).update(payload).digest();\n    } else {\n      if (curve === Slip10Curve.Ed25519) {\n        throw new Error(\"Normal keys are not allowed with ed25519\");\n      } else {\n        // Step 1 of https://github.com/satoshilabs/slips/blob/master/slip-0010.md#private-parent-key--private-child-key\n        // Calculate I = HMAC-SHA512(Key = c_par, Data = ser_P(point(k_par)) || ser_32(i)).\n        // where the functions point() and ser_p() are defined in BIP-0032\n        const data = new Uint8Array([...Slip10.serializedPoint(curve, new bn_js_1.default(parentPrivkey)), ...rawIndex.toBytesBigEndian()]);\n        i = new hmac_1.Hmac(sha_1.Sha512, parentChainCode).update(data).digest();\n      }\n    }\n\n    return this.childImpl(curve, parentPrivkey, parentChainCode, rawIndex, i);\n  }\n  /**\n   * Implementation of ser_P(point(k_par)) from BIP-0032\n   *\n   * @see https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki\n   */\n\n\n  static serializedPoint(curve, p) {\n    switch (curve) {\n      case Slip10Curve.Secp256k1:\n        return (0, encoding_1.fromHex)(secp256k1.g.mul(p).encodeCompressed(\"hex\"));\n\n      default:\n        throw new Error(\"curve not supported\");\n    }\n  }\n\n  static childImpl(curve, parentPrivkey, parentChainCode, rawIndex, i) {\n    // step 2 (of the Private parent key â†’ private child key algorithm)\n    const il = i.slice(0, 32);\n    const ir = i.slice(32, 64); // step 3\n\n    const returnChainCode = ir; // step 4\n\n    if (curve === Slip10Curve.Ed25519) {\n      return {\n        chainCode: returnChainCode,\n        privkey: il\n      };\n    } // step 5\n\n\n    const n = this.n(curve);\n    const returnChildKeyAsNumber = new bn_js_1.default(il).add(new bn_js_1.default(parentPrivkey)).mod(n);\n    const returnChildKey = Uint8Array.from(returnChildKeyAsNumber.toArray(\"be\", 32)); // step 6\n\n    if (this.isGteN(curve, il) || this.isZero(returnChildKey)) {\n      const newI = new hmac_1.Hmac(sha_1.Sha512, parentChainCode).update(new Uint8Array([0x01, ...ir, ...rawIndex.toBytesBigEndian()])).digest();\n      return this.childImpl(curve, parentPrivkey, parentChainCode, rawIndex, newI);\n    } // step 7\n\n\n    return {\n      chainCode: returnChainCode,\n      privkey: returnChildKey\n    };\n  }\n\n  static isZero(privkey) {\n    return privkey.every(byte => byte === 0);\n  }\n\n  static isGteN(curve, privkey) {\n    const keyAsNumber = new bn_js_1.default(privkey);\n    return keyAsNumber.gte(this.n(curve));\n  }\n\n  static n(curve) {\n    switch (curve) {\n      case Slip10Curve.Secp256k1:\n        return new bn_js_1.default(\"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141\", 16);\n\n      default:\n        throw new Error(\"curve not supported\");\n    }\n  }\n\n}\n\nexports.Slip10 = Slip10;\n\nfunction pathToString(path) {\n  return path.reduce((current, component) => {\n    const componentString = component.isHardened() ? `${component.toNumber() - 2 ** 31}'` : component.toString();\n    return current + \"/\" + componentString;\n  }, \"m\");\n}\n\nexports.pathToString = pathToString;\n\nfunction stringToPath(input) {\n  if (!input.startsWith(\"m\")) throw new Error(\"Path string must start with 'm'\");\n  let rest = input.slice(1);\n  const out = new Array();\n\n  while (rest) {\n    const match = rest.match(/^\\/([0-9]+)('?)/);\n    if (!match) throw new Error(\"Syntax error while reading path component\");\n    const [fullMatch, numberString, apostrophe] = match;\n    const value = math_1.Uint53.fromString(numberString).toNumber();\n    if (value >= 2 ** 31) throw new Error(\"Component value too high. Must not exceed 2**31-1.\");\n    if (apostrophe) out.push(Slip10RawIndex.hardened(value));else out.push(Slip10RawIndex.normal(value));\n    rest = rest.slice(fullMatch.length);\n  }\n\n  return out;\n}\n\nexports.stringToPath = stringToPath;","map":{"version":3,"mappings":"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","names":["Slip10Curve","exports","slip10CurveFromString","curveString","Ed25519","Secp256k1","Error","Slip10RawIndex","math_1","hardened","hardenedIndex","normal","normalIndex","isHardened","data","secp256k1","elliptic_1","ec","Slip10","derivePath","curve","seed","path","result","master","rawIndex","child","privkey","chainCode","i","hmac_1","sha_1","update","digest","il","slice","ir","isZero","isGteN","parentPrivkey","parentChainCode","payload","Uint8Array","toBytesBigEndian","serializedPoint","bn_js_1","childImpl","p","g","mul","encodeCompressed","returnChainCode","n","returnChildKeyAsNumber","add","mod","returnChildKey","from","toArray","newI","every","byte","keyAsNumber","gte","pathToString","reduce","current","component","componentString","toNumber","toString","stringToPath","input","startsWith","rest","out","Array","match","fullMatch","numberString","apostrophe","value","fromString","push","length"],"sourceRoot":"","sources":["../src/slip10.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}