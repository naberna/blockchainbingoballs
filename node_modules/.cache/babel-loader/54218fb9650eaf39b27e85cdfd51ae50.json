{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.encodeBech32Pubkey = exports.encodeAminoPubkey = exports.decodeBech32Pubkey = exports.decodeAminoPubkey = exports.encodeSecp256k1Pubkey = void 0;\n\nconst encoding_1 = require(\"@cosmjs/encoding\");\n\nconst math_1 = require(\"@cosmjs/math\");\n\nconst utils_1 = require(\"@cosmjs/utils\");\n\nconst pubkeys_1 = require(\"./pubkeys\");\n\nfunction encodeSecp256k1Pubkey(pubkey) {\n  if (pubkey.length !== 33 || pubkey[0] !== 0x02 && pubkey[0] !== 0x03) {\n    throw new Error(\"Public key must be compressed secp256k1, i.e. 33 bytes starting with 0x02 or 0x03\");\n  }\n\n  return {\n    type: pubkeys_1.pubkeyType.secp256k1,\n    value: (0, encoding_1.toBase64)(pubkey)\n  };\n}\n\nexports.encodeSecp256k1Pubkey = encodeSecp256k1Pubkey; // As discussed in https://github.com/binance-chain/javascript-sdk/issues/163\n// Prefixes listed here: https://github.com/tendermint/tendermint/blob/d419fffe18531317c28c29a292ad7d253f6cafdf/docs/spec/blockchain/encoding.md#public-key-cryptography\n// Last bytes is varint-encoded length prefix\n\nconst pubkeyAminoPrefixSecp256k1 = (0, encoding_1.fromHex)(\"eb5ae987\" + \"21\"\n/* fixed length */\n);\nconst pubkeyAminoPrefixEd25519 = (0, encoding_1.fromHex)(\"1624de64\" + \"20\"\n/* fixed length */\n);\nconst pubkeyAminoPrefixSr25519 = (0, encoding_1.fromHex)(\"0dfb1005\" + \"20\"\n/* fixed length */\n);\n/** See https://github.com/tendermint/tendermint/commit/38b401657e4ad7a7eeb3c30a3cbf512037df3740 */\n\nconst pubkeyAminoPrefixMultisigThreshold = (0, encoding_1.fromHex)(\"22c1f7e2\"\n/* variable length not included */\n);\n/**\n * Decodes a pubkey in the Amino binary format to a type/value object.\n */\n\nfunction decodeAminoPubkey(data) {\n  if ((0, utils_1.arrayContentStartsWith)(data, pubkeyAminoPrefixSecp256k1)) {\n    const rest = data.slice(pubkeyAminoPrefixSecp256k1.length);\n\n    if (rest.length !== 33) {\n      throw new Error(\"Invalid rest data length. Expected 33 bytes (compressed secp256k1 pubkey).\");\n    }\n\n    return {\n      type: pubkeys_1.pubkeyType.secp256k1,\n      value: (0, encoding_1.toBase64)(rest)\n    };\n  } else if ((0, utils_1.arrayContentStartsWith)(data, pubkeyAminoPrefixEd25519)) {\n    const rest = data.slice(pubkeyAminoPrefixEd25519.length);\n\n    if (rest.length !== 32) {\n      throw new Error(\"Invalid rest data length. Expected 32 bytes (Ed25519 pubkey).\");\n    }\n\n    return {\n      type: pubkeys_1.pubkeyType.ed25519,\n      value: (0, encoding_1.toBase64)(rest)\n    };\n  } else if ((0, utils_1.arrayContentStartsWith)(data, pubkeyAminoPrefixSr25519)) {\n    const rest = data.slice(pubkeyAminoPrefixSr25519.length);\n\n    if (rest.length !== 32) {\n      throw new Error(\"Invalid rest data length. Expected 32 bytes (Sr25519 pubkey).\");\n    }\n\n    return {\n      type: pubkeys_1.pubkeyType.sr25519,\n      value: (0, encoding_1.toBase64)(rest)\n    };\n  } else if ((0, utils_1.arrayContentStartsWith)(data, pubkeyAminoPrefixMultisigThreshold)) {\n    // eslint-disable-next-line @typescript-eslint/no-use-before-define\n    return decodeMultisigPubkey(data);\n  } else {\n    throw new Error(\"Unsupported public key type. Amino data starts with: \" + (0, encoding_1.toHex)(data.slice(0, 5)));\n  }\n}\n\nexports.decodeAminoPubkey = decodeAminoPubkey;\n/**\n * Decodes a bech32 pubkey to Amino binary, which is then decoded to a type/value object.\n * The bech32 prefix is ignored and discareded.\n *\n * @param bechEncoded the bech32 encoded pubkey\n */\n\nfunction decodeBech32Pubkey(bechEncoded) {\n  const {\n    data\n  } = (0, encoding_1.fromBech32)(bechEncoded);\n  return decodeAminoPubkey(data);\n}\n\nexports.decodeBech32Pubkey = decodeBech32Pubkey;\n/**\n * Uvarint decoder for Amino.\n * @see https://github.com/tendermint/go-amino/blob/8e779b71f40d175/decoder.go#L64-76\n * @returns varint as number, and bytes count occupied by varaint\n */\n\nfunction decodeUvarint(reader) {\n  if (reader.length < 1) {\n    throw new Error(\"Can't decode varint. EOF\");\n  }\n\n  if (reader[0] > 127) {\n    throw new Error(\"Decoding numbers > 127 is not supported here. Please tell those lazy CosmJS maintainers to port the binary.Varint implementation from the Go standard library and write some tests.\");\n  }\n\n  return [reader[0], 1];\n}\n/**\n * Decodes a multisig pubkey to type object.\n * Pubkey structure [ prefix + const + threshold + loop:(const + pubkeyLength + pubkey            ) ]\n *                  [   4b   + 1b    +  varint   + loop:(1b    +    varint    + pubkeyLength bytes) ]\n * @param data encoded pubkey\n */\n\n\nfunction decodeMultisigPubkey(data) {\n  const reader = Array.from(data); // remove multisig amino prefix;\n\n  const prefixFromReader = reader.splice(0, pubkeyAminoPrefixMultisigThreshold.length);\n\n  if (!(0, utils_1.arrayContentStartsWith)(prefixFromReader, pubkeyAminoPrefixMultisigThreshold)) {\n    throw new Error(\"Invalid multisig prefix.\");\n  } // remove 0x08 threshold prefix;\n\n\n  if (reader.shift() != 0x08) {\n    throw new Error(\"Invalid multisig data. Expecting 0x08 prefix before threshold.\");\n  } // read threshold\n\n\n  const [threshold, thresholdBytesLength] = decodeUvarint(reader);\n  reader.splice(0, thresholdBytesLength); // read participants pubkeys\n\n  const pubkeys = [];\n\n  while (reader.length > 0) {\n    // remove 0x12 threshold prefix;\n    if (reader.shift() != 0x12) {\n      throw new Error(\"Invalid multisig data. Expecting 0x12 prefix before participant pubkey length.\");\n    } // read pubkey length\n\n\n    const [pubkeyLength, pubkeyLengthBytesSize] = decodeUvarint(reader);\n    reader.splice(0, pubkeyLengthBytesSize); // verify that we can read pubkey\n\n    if (reader.length < pubkeyLength) {\n      throw new Error(\"Invalid multisig data length.\");\n    } // read and decode participant pubkey\n\n\n    const encodedPubkey = reader.splice(0, pubkeyLength);\n    const pubkey = decodeAminoPubkey(Uint8Array.from(encodedPubkey));\n    pubkeys.push(pubkey);\n  }\n\n  return {\n    type: pubkeys_1.pubkeyType.multisigThreshold,\n    value: {\n      threshold: threshold.toString(),\n      pubkeys: pubkeys\n    }\n  };\n}\n/**\n * Uvarint encoder for Amino. This is the same encoding as `binary.PutUvarint` from the Go\n * standard library.\n *\n * @see https://github.com/tendermint/go-amino/blob/8e779b71f40d175/encoder.go#L77-L85\n */\n\n\nfunction encodeUvarint(value) {\n  const checked = math_1.Uint53.fromString(value.toString()).toNumber();\n\n  if (checked > 127) {\n    throw new Error(\"Encoding numbers > 127 is not supported here. Please tell those lazy CosmJS maintainers to port the binary.PutUvarint implementation from the Go standard library and write some tests.\");\n  }\n\n  return [checked];\n}\n/**\n * Encodes a public key to binary Amino.\n */\n\n\nfunction encodeAminoPubkey(pubkey) {\n  if ((0, pubkeys_1.isMultisigThresholdPubkey)(pubkey)) {\n    const out = Array.from(pubkeyAminoPrefixMultisigThreshold);\n    out.push(0x08); // TODO: What is this?\n\n    out.push(...encodeUvarint(pubkey.value.threshold));\n\n    for (const pubkeyData of pubkey.value.pubkeys.map(p => encodeAminoPubkey(p))) {\n      out.push(0x12); // TODO: What is this?\n\n      out.push(...encodeUvarint(pubkeyData.length));\n      out.push(...pubkeyData);\n    }\n\n    return new Uint8Array(out);\n  } else if ((0, pubkeys_1.isEd25519Pubkey)(pubkey)) {\n    return new Uint8Array([...pubkeyAminoPrefixEd25519, ...(0, encoding_1.fromBase64)(pubkey.value)]);\n  } else if ((0, pubkeys_1.isSecp256k1Pubkey)(pubkey)) {\n    return new Uint8Array([...pubkeyAminoPrefixSecp256k1, ...(0, encoding_1.fromBase64)(pubkey.value)]);\n  } else {\n    throw new Error(\"Unsupported pubkey type\");\n  }\n}\n\nexports.encodeAminoPubkey = encodeAminoPubkey;\n/**\n * Encodes a public key to binary Amino and then to bech32.\n *\n * @param pubkey the public key to encode\n * @param prefix the bech32 prefix (human readable part)\n */\n\nfunction encodeBech32Pubkey(pubkey, prefix) {\n  return (0, encoding_1.toBech32)(prefix, encodeAminoPubkey(pubkey));\n}\n\nexports.encodeBech32Pubkey = encodeBech32Pubkey;","map":{"version":3,"mappings":"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","names":["encodeSecp256k1Pubkey","pubkey","length","Error","type","pubkeys_1","secp256k1","value","exports","pubkeyAminoPrefixSecp256k1","pubkeyAminoPrefixEd25519","pubkeyAminoPrefixSr25519","pubkeyAminoPrefixMultisigThreshold","decodeAminoPubkey","data","rest","slice","ed25519","sr25519","decodeMultisigPubkey","decodeBech32Pubkey","bechEncoded","decodeUvarint","reader","Array","from","prefixFromReader","splice","shift","threshold","thresholdBytesLength","pubkeys","pubkeyLength","pubkeyLengthBytesSize","encodedPubkey","Uint8Array","push","multisigThreshold","toString","encodeUvarint","checked","math_1","fromString","toNumber","encodeAminoPubkey","out","pubkeyData","map","p","encodeBech32Pubkey","prefix"],"sourceRoot":"","sources":["../src/encoding.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}